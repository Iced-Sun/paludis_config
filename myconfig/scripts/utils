#!/usr/bin/env bash

has_ipv6() {
    {
	if which ip; then
	    ip -6 a | grep inet6 | grep global && return 0
	elif which ifconfig; then
	    ifconfig | grep inet6 | grep global && return 0
	fi

	return 1
    } >/dev/null 2>&1
}

is_in_2112() {
    has_ipv6
}

## NOTE this is best done in hooks, but ebuild_configure_pre and
## src_configure are executed in different context; we need to inject
## enable_distcc into src_configure directly
wrap_ebuild_phase() {
    einfo_unhooked "Wrapping the ${EXHERES_PHASE} phase..."
    
    while [[ "$#" -gt 0 ]]; do
	group=()
	while true; do
	    if [[ x"$1" == "x:WRAP_END:" ]]; then
		shift
		einfo_unhooked "  Running the wrapper ${group[@]}..."
		"${group[@]}"
		break
	    elif [[ "$#" -eq 0 ]]; then
		einfo_unhooked "  Entering the ${EXHERES_PHASE} phase..."
	    
		## FIXME shall we add CFLAGS="${CFLAGS}" CXXFLAGS="${CXXFLAGS}"
		## LDFLAGS="${LDFLAGS}" to enforce the flags?
		if [[ ${EXHERES_PHASE} == "configure" ]]; then
		    einfo_unhooked "  Applying EXTRA_ECONF..."
		    edo "${group[@]}" "${EXTRA_ECONF[@]}"
		else
		    edo "${group[@]}"
		fi
	    
		break
	    else
		group+=( "$1" )
		shift
	    fi
	done
    done
}

distcc_setup_path() {
    if is_in_2112; then
	if [[ $PATH != "/usr/${CHOST}/libexec/distcc:"* ]]; then
	    export PATH="/usr/${CHOST}/libexec/distcc:${PATH}"
	fi
	export DISTCC_DIR="/var/tmp/paludis/distcc"
    fi
}

distcc_setup_hosts() {
    if is_in_2112; then
	if [[ x"$1" != "xnohost" ]]; then
	    ## TODO check if distcc is available
	    ## TODO use lsdistcc to determine values
	    export EXJOBS=10
            #export DISTCC_HOSTS='--randomize [2001:da8:201:1071:2112::],lzo'
	    export DISTCC_HOSTS='--randomize 10.2.112.3,lzo'
	fi
    fi
    #EMAKE_WRAPPER="pump"
    #192.168.1.50,lzo,cpp
}

distcc_allow_net() {
    if is_in_2112; then
	#edo esandbox allow_net --connect "inet6:2001:da8:201:1071:2112::/64@3632"
	edo esandbox allow_net --connect "inet:10.2.112.3@3632"
    fi
}

## econf: FUNCTION in exheres-0/build_functions.bash
## emake: SCRIPT of utils/exheres-0/emake
## ecmake: FUNCTION in arbor/exlib/cmake.exlib
emake() {
    ## NOTE this is over-killing
    #declare -F | while read line; do edo export -f `echo "${line}" | cut -d' ' -f3`;  done

    export -f einfo_unhooked edo paludis_ecmd
    export -f wrap_ebuild_phase distcc_setup_hosts distcc_allow_net is_in_2112 has_ipv6

    ewarn "A wrapped version of emake is invoked..."
    /usr/${CHOST}/libexec/paludis/utils/exheres-0/emake "$@"
}


