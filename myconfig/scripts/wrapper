#!/bin/bash

init_action() {
	## determine the invoking role of the script
  local INVOKER_FULL_PATH=`realpath -s $0`
	local INVOKER=${INVOKER_FULL_PATH#$PALUDIS_CONFIG_DIR/}
	local INVOKER_DIRNAME=`dirname $INVOKER`
	local INVOKER_BASENAME=`basename $INVOKER`

	## generate ACTION, SUB_ACTION
  if [[ "wrapper" == "$INVOKER_BASENAME" ]]; then
		# directly call the script itself
		ACTION=wrapper
		SUB_ACTION=$1
  elif [[ " sets repositories " =~ " $INVOKER_DIRNAME " ]]; then
		# called by sets/*.bash, repositories/*.bash
		ACTION=$INVOKER_DIRNAME
		SUB_ACTION=${INVOKER_BASENAME%.bash}
  elif [[ "." == $INVOKER_DIRNAME ]]; then
		# called by *.bash
		ACTION=${INVOKER_BASENAME%.bash}
  else
		## this should not happen
		ACTION=${INVOKER_BASENAME}
	fi
}

print_debug_info() {
	cat <<EOF

===== Host =====
Host:				${HOST}
Machine ID:			${MACHINE_ID}

===== Paludis =====
Paludis config DIR:		${PALUDIS_CONFIG_DIR}
Destination:			${LOCATION}
Predefined weak sets:		${PREDEFINED_SETS[@]}
General sets:			${GENERAL_SETS[@]}
Machine sets:  			${MACHINE_SETS[@]}

===== Configurations =====
Custom config DIR (relative):	${CONFIG_DIR}
Action/Configuration:		${ACTION}$([[ x${SUB_ACTION} == "x" ]] || echo ::${SUB_ACTION}).conf
Active sets:			${ACTIVE_SETS[@]}

===== End =====

EOF
}

## global environments
HOST=$(hostname | cut -d. -f1)
MACHINE_ID=$(cat /etc/machine-id)
PALUDIS_CONFIG_DIR=${PALUDIS_CONFIG_DIR:=/etc/paludis}

## initialization
init_action

## if the caller is not paludis, print debug info
[[ x$PALUDIS_CLIENT == "x" ]] && print_debug_info 1>&2
